# Тестовое задание на позицию стажера-бекендера
# Сервис динамического сегментирования пользователей

### Проблема:

В Авито часто проводятся различные эксперименты — тесты новых продуктов, тесты интерфейса, скидочные и многие другие.
На архитектурном комитете приняли решение централизовать работу с проводимыми экспериментами и вынести этот функционал в отдельный сервис.

### Задача:

Требуется реализовать сервис, хранящий пользователя и сегменты, в которых он состоит (создание, изменение, удаление сегментов, а также добавление и удаление пользователей в сегмент)

### Решение:

В ходе работы, был создан сервис, позволяющий выполнять следующие операции:

1. Метод создания сегмента. Принимает название сегмента.
2. Метод удаления сегмента. Принимает название сегмента.
3. Метод добавления пользователя в сегмент. Принимает список названий сегментов, которые нужно добавить пользователю и список названий сегментов, которые нужно удалить у пользователя, а также id пользователя.
4. Метод получения активных сегментов пользователя. Принимает на вход id пользователя.

А также решены все опциональные задачи:

1. Реализован механизм сохранения истории (попадания/выбывания) пользователя из сегмента и возможность получения отчета по пользователю за определенный период. На вход: месяц и год. На выходе ссылка на CSV файл.
2. Реализована возможность задавать TTL (время автоматического удаления пользователя из сегмента).
3. Автоматизирована задача по добавлению заданного процента пользователей в создаваемый сегмент.

При разработке данного сервиса также соблюдены необходимые технические требования, а именно:
1. Сервис предоставляет HTTP API с форматом JSON как при отправке запроса, так и при получении результата.
2. Язык разработки: Golang.
3. Реляционная СУБД: PostgreSQL.
4. Использование docker и docker-compose для поднятия и развертывания dev-среды.
5. Весь код выложен на Github с Readme файлом и с инструкцией по запуску и примерами запросов/ответов.
6. Все возникшие вопросы и варианты решения оставлены в списке, который расположен конце данного README файла.

### Используемые библиотеки и технологии при разработке
* [httprouter](https://github.com/julienschmidt/httprouter) - Httprouter by Julienschmidt
* [pgx](https://github.com/jackc/pgx) - PostgreSQL driver and toolkit for Go
* [cleanenv](https://github.com/ilyakaznacheev/cleanenv) - Go configuration
* [logrus](https://github.com/sirupsen/logrus) - Logger
* [swag](https://github.com/swaggo/swag) - Swagger
* [testify](https://github.com/stretchr/testify) - Testing toolkit
* [mockery](https://github.com/vektra/mockery) - Mocking framework
* [csvutil](https://github.com/jszwec/csvutil) - Csv utility
* [Docker](https://www.docker.com/) - Docker

### Примеры использования API сервиса:
Некоторые примеры запросов
- [Создание сегмента](#create-segment)
- [Удалить сегмент](#delete-segment)
- [Добавить сегмент пользователю](#add-segment-to-user)
- [Получить активные сегменты у пользователя](#get-active-segments-from-user)
- [Получение отчета в формате CSV по сегментам пользователя](#segment-report-link)
- [Автоматическое удаление пользователя из сегмента (TTl) ](#segment-ttl)

### Процесс создания сегмента <a name="create-segment"></a>

***Внимание***: Опциональное задание №3: " ***В методе создания сегмента***, добавить опцию указания процента пользователей, которые будут попадать в сегмент автоматически. 
В методе получения сегментов пользователя, добавленный сегмент должен отдаваться у заданного процента пользователей."
Таким образом, расширяем уже существующий функционал ***опциональным*** полем **"percent"**. 
- В случае отсутствия необходимости автоматически добавлять сегмент заданному проценту пользователей - поле опускается.

Пример создания сегмента:
```curl
curl --location --request POST 'http://localhost:8080/api/segments/' \
--header 'Content-Type: application/json' \
--data-raw '{
    "name":"discount90",
    "percent":80
}'
```
Пример ответа:
```json
{
  "description":"Content created",
  "developer_msg":"201 Created",
  "code":"Avito_Segment_Service-000201"
}
```
### Процесс удаления сегмента <a name="delete-segment"></a>

Пример удаление сегмента:
```curl
curl --location --request DELETE 'http://localhost:8080/api/segments/' \
--header 'Content-Type: application/json' \
--data-raw '{
    "name":"discount90"
}'
```
Пример ответа:
```json
{
    "description": "Content deleted",
    "developer_msg": "200 OK",
    "code": "Avito_Segment_Service-000204"
}
```

### Процесс добавления/удаления сегмента пользователю <a name="create-segment"></a>
***Внимание***: Опциональное задание №2: "Для реализации Ttl В ***метод добавления сегментов*** пользователю передаём время удаления пользователя из сегмента отдельным полем".
Таким образом, расширяем уже существующий функционал ***опциональным*** полем **"ttl"**.

- В случае отсутствия необходимости добавлять пользователю время действия(жизни) сегмента - поле опускается.

- В случае отсутствия необходимости удалять пользователю сегмент - поле опускается.

Пример добавления/ удаления сегментов пользователю/ у пользователя.
```curl
curl --location --request PUT 'http://localhost:8080/api/segments/' \
--header 'Content-Type: application/json' \
--data-raw '{
    "userID":"2",
    "add":[
        {
            "name":"discount50",
            "ttl_days":3
        },
        {
            "name":"discount30" 
        }
    ],
    "delete":["discount80"]
}'
```
Пример ответа:
```json
{
    "description": "Content updated",
    "developer_msg": "200 OK",
    "code": "Avito_Segment_Service-000200"
}
```

### Процесс получения активных сегментов у пользователя

Пример получения активных сегментов у пользователя с id=2
```curl 
curl --location --request GET 'http://localhost:8080/api/segments/2' \
--header 'Content-Type: application/json'
```

Пример ответа:
```json
[
    {
        "ID": "12",
        "name": "discount30"
    },
    {
        "ID": "13",
        "name": "discount50"
    }
]
```

soon...